<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Çöçi AI – Ücretsiz Tarayıcı-İçi Sohbet</title>
  <meta name="description" content="Çöçi AI, tamamen ücretsiz ve sunucusuz. Yapay zeka modelini tarayıcınızda çalıştırır (WebGPU)." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ccircle cx='128' cy='128' r='120' fill='%23e74c3c'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto' font-size='120' fill='white'%3EÇ%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#0b0d10;--panel:#12161b;--muted:#8892a6;--text:#eef2ff;--accent:#e74c3c;--accent-2:#f39c12;
      --radius:18px;--radius-sm:12px;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:radial-gradient(1200px 800px at 80% -20%,rgba(231,76,60,.12),transparent 60%),radial-gradient(1200px 800px at 20% 120%,rgba(243,156,18,.12),transparent 60%),var(--bg);color:var(--text)}
    .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(140%) blur(8px);background:linear-gradient(to bottom,rgba(11,13,16,.9),rgba(11,13,16,.6));border-bottom:1px solid #1b2330}
    .bar{max-width:980px;margin:auto;display:flex;gap:16px;align-items:center;padding:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-badge{width:36px;height:36px;border-radius:50%;background:conic-gradient(from 190deg at 50% 50%,var(--accent),var(--accent-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo-badge span{font-weight:800;color:#fff}
    h1{font-size:18px;margin:0}
    .grow{flex:1}
    select,button{border:1px solid #283245;background:#0f1318;color:var(--text);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--accent),#ff6b4a);border:none}
    main{max-width:980px;margin:18px auto;padding:0 16px}
    .chat{display:flex;flex-direction:column;gap:14px}
    .msg{display:flex;gap:12px;align-items:flex-start}
    .msg .avatar{width:36px;height:36px;border-radius:50%;flex:0 0 auto;display:grid;place-items:center;background:#1a222e;color:#fff;font-weight:700}
    .bubble{background:var(--panel);border:1px solid #1b2330;padding:12px 14px;border-radius:var(--radius-sm);max-width:80%;box-shadow:var(--shadow);white-space:pre-wrap}
    .user .bubble{background:#13212a;border-color:#183341}
    .assistant .bubble{background:#171b22}
    .sys{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .progress{height:8px;background:#0f1318;border:1px solid #1b2330;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
    footer{position:sticky;bottom:0;background:linear-gradient(to top,rgba(11,13,16,.96),rgba(11,13,16,.65));border-top:1px solid #1b2330}
    .composer{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:flex-end}
    textarea{flex:1;background:#0f1318;border:1px solid #283245;color:var(--text);border-radius:14px;min-height:54px;max-height:180px;padding:12px 14px;outline:none;resize:vertical}
    .hint{font-size:12px;color:var(--muted);text-align:center;margin:8px 0}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f1318;border:1px solid #283245;font-size:12px;color:#d2daf0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .blink{animation:blink 1.1s infinite}
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}
    a, a:visited{color:#93c5fd}
    
    /* Responsive düzenlemeler */
    @media (max-width: 768px) {
      .bar { flex-direction: column; align-items: flex-start; }
      .row { width: 100%; justify-content: space-between; }
      .bubble { max-width: 90%; }
      .composer { flex-direction: column; }
      textarea { width: 100%; }
    }
    
    /* Yükleme animasyonu */
    .loader { 
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://esm.run" crossorigin>
  <link rel="preconnect" href="https://huggingface.co" crossorigin>
</head>
<body>
<div class="wrap">
  <header>
    <div class="bar">
      <div class="logo">
        <div class="logo-badge"><span>Ç</span></div>
        <div>
          <h1>Çöçi AI</h1>
          <div class="sys">Sunucusuz • %100 ücretsiz • Tarayıcıda çalışır</div>
        </div>
      </div>
      <div class="grow"></div>
      <div class="row">
        <label class="pill">
          <span>Model:</span>
          <select id="model">
            <option value="Llama-3.2-1B-Instruct-q4f32_1-MLC">Llama 3.2 1B (hızlı)</option>
            <option value="Llama-3.2-3B-Instruct-q4f32_1-MLC">Llama 3.2 3B (daha iyi)</option>
          </select>
        </label>
        <button id="reset" title="Sohbeti temizle">Yeni Sohbet</button>
      </div>
    </div>
  </header>

  <main>
    <div id="notice" class="hint">İlk yüklemede model dosyaları tarayıcınıza indirilir ve cihazınızda saklanır. WebGPU destekli bir tarayıcı önerilir (Chrome/Edge, masaüstü).</div>

    <div id="progress-wrap" class="hidden">
      <div class="progress" aria-label="Yükleme durumu"><span id="progress-bar"></span></div>
      <div id="progress-text" class="hint">Model hazırlanıyor…</div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>
  </main>

  <footer>
    <div class="composer">
      <textarea id="input" placeholder="Çöçi AI'a yaz… (Enter: gönder, Shift+Enter: satır)" autocomplete="off"></textarea>
      <button id="send" class="primary" type="button">Gönder</button>
    </div>
    <div class="hint" id="status">Hazır</div>
  </footer>
</div>

<script type="module">
// Çöçi AI – tarayıcıda çalışan ücretsiz sohbet (GitHub Pages uyumlu)
(function(){
  const d = (sel) => document.querySelector(sel);
  const chatEl = d('#chat');
  const inputEl = d('#input');
  const sendBtn = d('#send');
  const resetBtn = d('#reset');
  const modelSel = d('#model');
  const pWrap = d('#progress-wrap');
  const pBar = d('#progress-bar');
  const pText = d('#progress-text');
  const notice = d('#notice');
  const statusEl = d('#status');

  let engine = null;
  let busy = false;
  let CreateMLCEngine = null;

  let messages = [
    { role: 'system', content: 'Sen Çöçi AI\'sın. Türkçe doğal ve kısa cevaplar ver. Kullanıcı basit, ücretsiz bir sohbet istiyor. Hakaret etmeyip yardımcı ol.' }
  ];

  // localStorage'dan model tercihini yükle
  const savedModel = localStorage.getItem('cochi_model') || modelSel.value;
  modelSel.value = savedModel;

  function checkSupport(){
    const secure = window.isSecureContext;
    const gpu = !!navigator.gpu;
    let problems = [];
    if (!secure) problems.push('Bu sayfayı HTTPS üzerinden açmanız gerekiyor.');
    if (!gpu) problems.push('Tarayıcınızda WebGPU etkin değil. Güncel masaüstü Chrome/Edge kullanmanız önerilir.');
    return { ok: secure && gpu, secure, gpu, problems };
  }

  function addMsg(role, content) {
    const wrap = document.createElement('div');
    wrap.className = `msg ${role}`;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? '👤' : (role === 'assistant' ? '🤖' : 'ℹ️');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = content;
    wrap.appendChild(avatar);
    wrap.appendChild(bubble);
    chatEl.appendChild(wrap);
    chatEl.scrollTo({top: chatEl.scrollHeight, behavior: 'smooth'});
    return bubble;
  }

  function setProgress(show, ratio=0, text=''){
    pWrap.classList.toggle('hidden', !show);
    if(show){
      pBar.style.width = Math.round(ratio*100) + '%';
      pText.textContent = text || 'Model yükleniyor…';
    }
  }

  function setStatus(text) {
    statusEl.textContent = text;
  }

  async function loadLib(){
    if (CreateMLCEngine) return;
    try {
      // Web-LLM kütüphanesini yükle
      setStatus('Kütüphane yükleniyor...');
      ({ CreateMLCEngine } = await import('https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/+esm'));
      setStatus('Kütüphane yüklendi');
    } catch (e) {
      console.warn('jsDelivr olmadı, esm.run deneniyor…', e);
      try {
        ({ CreateMLCEngine } = await import('https://esm.run/@mlc-ai/web-llm'));
        setStatus('Kütüphane yüklendi');
      } catch (err) {
        console.error('Her iki CDN de başarısız oldu', err);
        setStatus('Kütüphane yüklenemedi');
        throw new Error('Kütüphane yüklenemedi');
      }
    }
  }

  async function initEngine() {
    if (engine) return;

    const support = checkSupport();
    if (!support.ok){
      notice.style.display = 'block';
      notice.innerHTML = 'WebGPU gerekli. <b>Hızlı çözüm:</b> Güncel Chrome/Edge kullanın. ' + 
                         (support.problems.length? '<br>• ' + support.problems.join('<br>• ') : '');
      setStatus('WebGPU veya HTTPS sorunu');
      throw new Error('WebGPU/secure-context yok');
    }

    setProgress(true, 0, 'Model hazırlanıyor…');
    notice.style.display = 'none';
    setStatus('Motor hazırlanıyor...');

    await loadLib();

    const model = modelSel.value;
    localStorage.setItem('cochi_model', model);
    
    try {
      engine = await CreateMLCEngine(
        { model },
        {
          initProgressCallback: (p) => {
            const r = Number(p?.progress || 0);
            setProgress(true, r, p?.text || 'İndiriliyor…');
            setStatus(`Model yükleniyor: ${Math.round(r*100)}%`);
            if (r >= 1) {
              setTimeout(() => setProgress(false), 400);
              setStatus('Model yüklendi, hazır');
            }
          }
        }
      );
    } catch (error) {
      console.error('Motor başlatma hatası:', error);
      setStatus('Motor başlatılamadı');
      setProgress(false);
      throw error;
    }
  }

  async function ensureEngineReady(){
    if (!engine) await initEngine();
  }

  async function send() {
    if (busy) return;
    const text = inputEl.value.trim();
    if (!text) return;

    busy = true;
    inputEl.value = '';
    inputEl.disabled = true;
    sendBtn.disabled = true;
    addMsg('user', text);
    const botBubble = addMsg('assistant', '…');
    botBubble.classList.add('blink');

    messages.push({ role: 'user', content: text });

    try {
      await ensureEngineReady();
      setStatus('Cevap oluşturuluyor...');

      let finalText = '';
      const stream = await engine.chat.completions.create({
        stream: true,
        messages,
        temperature: 0.7,
        max_tokens: 512,
      });

      botBubble.textContent = '';
      for await (const part of stream) {
        const delta = part?.choices?.[0]?.delta?.content || '';
        if (delta) {
          finalText += delta;
          botBubble.textContent = finalText;
          chatEl.scrollTo({top: chatEl.scrollHeight});
        }
      }

      messages.push({ role: 'assistant', content: finalText || '🤖' });
      setStatus('Hazır');
    } catch (err) {
      console.error('Gönderme hatası:', err);
      botBubble.classList.remove('blink');
      const s = checkSupport();
      let hint = 'Bir sorun oluştu. ';
      if (!s.secure) hint += ' HTTPS bağlantısı gerekli. ';
      if (!s.gpu) hint += ' WebGPU destekli tarayıcı gerekli. ';
      hint += ' Lütfen konsolu kontrol edin.';
      botBubble.textContent = hint;
      setStatus('Hata oluştu');
    } finally {
      botBubble.classList.remove('blink');
      busy = false;
      inputEl.disabled = false;
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }

  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });
  resetBtn.addEventListener('click', () => {
    messages = messages.slice(0,1);
    chatEl.innerHTML = '';
    addMsg('assistant', 'Yeni sohbete hazırım. Ne sormak istersin?');
    setStatus('Yeni sohbet başlatıldı');
  });
  modelSel.addEventListener('change', async () => {
    const want = modelSel.value;
    localStorage.setItem('cochi_model', want);
    if (engine) {
      engine.unload();
      engine = null;
    }
    setProgress(true, 0, 'Model değiştiriliyor…');
    setStatus('Model değiştiriliyor...');
    try { 
      await initEngine(); 
      addMsg('assistant', `Model değişti: ${modelSel.options[modelSel.selectedIndex].text}. Devam edebiliriz.`);
      setStatus('Model değiştirildi');
    } catch(err) {
      console.error('Model değiştirme hatası:', err);
      setStatus('Model değiştirilemedi');
      addMsg('assistant', 'Model değiştirilirken hata oluştu. Lütfen sayfayı yenileyin.');
    }
  });

  // Sayfa yüklendiğinde kontrol et
  window.addEventListener('load', () => {
    const s = checkSupport();
    if (!s.ok){
      notice.innerHTML = '💡 Çalışması için: <b>1)</b> WebGPU\'lu tarayıcı kullan (masaüstü Chrome/Edge).';
      setStatus('WebGPU gerekli');
    } else {
      setStatus('Hazır');
      // Motoru önceden yükle
      setTimeout(() => {
        initEngine().catch(err => console.log('Ön yükleme başarısız oldu:', err));
      }, 1000);
    }
    addMsg('assistant', 'Merhaba! Ben Çöçi AI. Tamamen ücretsizim ve tarayıcında çalışıyorum. Bana istediğini sorabilirsin.');
  });
})();
</script>
</body>
</html>