<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Çöçi AI – Ücretsiz Tarayıcı-İçi Sohbet</title>
  <meta name="description" content="Çöçi AI, tamamen ücretsiz ve sunucusuz. Yapay zeka modelini tarayıcınızda çalıştırır (WebGPU)." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ccircle cx='128' cy='128' r='120' fill='%23e74c3c'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto' font-size='120' fill='white'%3EÇ%3C/text%3E%3C/svg%3E" />
  <!-- Ağ hızını düzeltmek için ön-bağlantılar -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://esm.run" crossorigin>
  <link rel="preconnect" href="https://huggingface.co" crossorigin>
  <style>
    :root{
      --bg:#0b0d10;--panel:#12161b;--muted:#8892a6;--text:#eef2ff;--accent:#e74c3c;--accent-2:#f39c12;
      --radius:18px;--radius-sm:12px;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:radial-gradient(1200px 800px at 80% -20%,rgba(231,76,60,.12),transparent 60%),radial-gradient(1200px 800px at 20% 120%,rgba(243,156,18,.12),transparent 60%),var(--bg);color:var(--text)}
    .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(140%) blur(8px);background:linear-gradient(to bottom,rgba(11,13,16,.9),rgba(11,13,16,.6));border-bottom:1px solid #1b2330}
    .bar{max-width:980px;margin:auto;display:flex;gap:16px;align-items:center;padding:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-badge{width:36px;height:36px;border-radius:50%;background:conic-gradient(from 190deg at 50% 50%,var(--accent),var(--accent-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo-badge span{font-weight:800;color:#fff}
    h1{font-size:18px;margin:0}
    .grow{flex:1}
    select,button{border:1px solid #283245;background:#0f1318;color:var(--text);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--accent),#ff6b4a);border:none}
    main{max-width:980px;margin:18px auto;padding:0 16px}
    .chat{display:flex;flex-direction:column;gap:14px}
    .msg{display:flex;gap:12px;align-items:flex-start}
    .msg .avatar{width:36px;height:36px;border-radius:50%;flex:0 0 auto;display:grid;place-items:center;background:#1a222e;color:#fff;font-weight:700}
    .bubble{background:var(--panel);border:1px solid #1b2330;padding:12px 14px;border-radius:var(--radius-sm);max-width:80%;box-shadow:var(--shadow);white-space:pre-wrap}
    .user .bubble{background:#13212a;border-color:#183341}
    .assistant .bubble{background:#171b22}
    .sys{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .progress{height:8px;background:#0f1318;border:1px solid #1b2330;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
    footer{position:sticky;bottom:0;background:linear-gradient(to top,rgba(11,13,16,.96),rgba(11,13,16,.65));border-top:1px solid #1b2330}
    .composer{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:flex-end}
    textarea{flex:1;background:#0f1318;border:1px solid #283245;color:var(--text);border-radius:14px;min-height:54px;max-height:180px;padding:12px 14px;outline:none;resize:vertical}
    .hint{font-size:12px;color:var(--muted);text-align:center;margin:8px 0}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f1318;border:1px solid #283245;font-size:12px;color:#d2daf0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .blink{animation:blink 1.1s infinite}
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}
    a, a:visited{color:#93c5fd}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="bar">
      <div class="logo">
        <div class="logo-badge"><span>Ç</span></div>
        <div>
          <h1>Çöçi AI</h1>
          <div class="sys">Sunucusuz • %100 ücretsiz • Tarayıcıda çalışır</div>
        </div>
      </div>
      <div class="grow"></div>
      <div class="row">
        <label class="pill">
          <span>Model:</span>
          <select id="model">
            <option value="Llama-3.2-1B-Instruct-q4f32_1-MLC">Llama 3.2 1B (hızlı)</option>
            <option value="Llama-3.2-3B-Instruct-q4f32_1-MLC">Llama 3.2 3B (daha iyi)</option>
          </select>
        </label>
        <button id="reset" title="Sohbeti temizle">Yeni Sohbet</button>
      </div>
    </div>
  </header>

  <main>
    <div id="notice" class="hint">İlk yüklemede model dosyaları tarayıcınıza indirilir ve cihazınızda saklanır. WebGPU destekli bir tarayıcı önerilir (Chrome/Edge, masaüstü).</div>
    <div id="progress-wrap" class="hidden">
      <div class="progress" aria-label="Yükleme durumu"><span id="progress-bar"></span></div>
      <div id="progress-text" class="hint">Model hazırlanıyor…</div>
    </div>
    <div id="chat" class="chat" aria-live="polite"></div>
  </main>

  <footer>
    <div class="composer">
      <textarea id="input" placeholder="Çöçi AI'a yaz…  (Enter: gönder, Shift+Enter: satır)" autocomplete="off"></textarea>
      <button id="send" class="primary" type="button">Gönder</button>
    </div>
  </footer>
</div>

<script type="module">
// Çöçi AI — GitHub Pages uyumlu, WebLLM tabanlı, tek dosya
(function(){
  const $ = (s) => document.querySelector(s);
  const chatEl = $('#chat');
  const inputEl = $('#input');
  const sendBtn = $('#send');
  const resetBtn = $('#reset');
  const modelSel = $('#model');
  const pWrap = $('#progress-wrap');
  const pBar = $('#progress-bar');
  const pText = $('#progress-text');
  const notice = $('#notice');

  let engine = null;
  let busy = false;
  let CreateMLCEngine = null;

  let messages = [
    { role: 'system', content: 'Sen Çöçi AI\'sın. Türkçe, doğal ve kısa cevaplar ver. Kullanıcı basit ve ücretsiz bir sohbet ister. Yardımcı ol, kaba olma.' }
  ];

  // Kalıcı model seçimi
  modelSel.value = localStorage.getItem('cochi_model') || modelSel.value;

  // Destek kontrolü
  function support(){
    const secure = window.isSecureContext || location.protocol.startsWith('https') || /^(localhost|127\.0\.0\.1)$/.test(location.hostname);
    const gpu = !!navigator.gpu;
    return {ok: secure && gpu, secure, gpu};
  }

  // UI yardımcıları
  function addMsg(role, content){
    const wrap = document.createElement('div');
    wrap.className = `msg ${role}`;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? '👤' : (role === 'assistant' ? '🤖' : 'ℹ️');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = content;
    wrap.appendChild(avatar);wrap.appendChild(bubble);
    chatEl.appendChild(wrap);
    chatEl.scrollTo({top: chatEl.scrollHeight, behavior: 'smooth'});
    return bubble;
  }
  function setProgress(show, ratio=0, text=''){
    pWrap.classList.toggle('hidden', !show);
    if(show){ pBar.style.width = Math.round(ratio*100)+'%'; pText.textContent = text || 'Model yükleniyor…'; }
  }

  // Kütüphaneyi farklı CDN'lerden dene (jsDelivr → esm.run → unpkg)
  async function loadLib(){
    if (CreateMLCEngine) return;
    const urls = [
      'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/+esm',
      'https://esm.run/@mlc-ai/web-llm',
      'https://unpkg.com/@mlc-ai/web-llm/dist/index.js'
    ];
    let lastErr = null;
    for (const u of urls){
      try { const mod = await import(u); CreateMLCEngine = mod.CreateMLCEngine || mod.default?.CreateMLCEngine; if (CreateMLCEngine) return; }
      catch(e){ lastErr = e; console.warn('CDN denemesi başarısız:', u, e); }
    }
    throw lastErr || new Error('WebLLM yüklenemedi');
  }

  async function initEngine(){
    if (engine) return;
    const s = support();
    if (!s.ok){
      notice.style.display = 'block';
      let why = !s.secure ? 'Bu sayfayı https veya localhost üzerinden aç.' : '';
      if (!s.gpu) why += (why?' ':'') + 'Tarayıcında WebGPU yok/kapalı. Güncel masaüstü Chrome/Edge kullan.';
      notice.innerHTML = 'Çalışması için: '+why;
      throw new Error('Destek yok');
    }

    setProgress(true, 0, 'Model hazırlanıyor…');
    notice.style.display = 'none';

    await loadLib();

    const model = modelSel.value;
    localStorage.setItem('cochi_model', model);

    engine = await CreateMLCEngine(
      { model },
      {
        initProgressCallback: (p) => {
          const r = Number(p?.progress || 0);
          setProgress(true, r, p?.text || 'İndiriliyor…');
          if (r >= 1) setTimeout(() => setProgress(false), 350);
        }
      }
    );
  }

  async function ensureEngine(){ if(!engine) await initEngine(); }

  async function send(){
    if (busy) return;
    const text = inputEl.value.trim();
    if (!text) return;

    busy = true; inputEl.value='';
    addMsg('user', text);
    const bot = addMsg('assistant', '…'); bot.classList.add('blink');

    messages.push({ role:'user', content:text });
    try{
      await ensureEngine();
      let final = '';
      const stream = await engine.chat.completions.create({ stream: true, messages, temperature: 0.7, max_tokens: 512 });
      bot.textContent='';
      for await (const part of stream){
        const delta = part?.choices?.[0]?.delta?.content || '';
        if (delta){ final += delta; bot.textContent = final; chatEl.scrollTo({top:chatEl.scrollHeight}); }
      }
      messages.push({ role:'assistant', content: final || '🤖' });
    }catch(err){
      console.error('Çöçi hata:', err);
      const s = support();
      let hint = 'Bir sorun oluştu.';
      if (!s.secure) hint += ' Bu sayfayı https veya localhost üzerinden aç.';
      if (!s.gpu) hint += ' WebGPU yok/kapalı. Güncel Chrome/Edge (masaüstü) kullan.';
      if (String(err).includes('Failed to fetch dynamically imported module')) hint += ' Ağ/CDN modülü yüklenemedi. Sayfayı Ctrl+F5 ile yenile veya farklı ağ dene.';
      if (String(err).includes('Out of memory')) hint += ' Bellek yetersiz. Modeli 1B seç.';
      bot.textContent = hint;
    }finally{
      bot.classList.remove('blink'); busy=false; inputEl.focus();
    }
  }

  // Olaylar
  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  resetBtn.addEventListener('click', ()=>{ messages = messages.slice(0,1); chatEl.innerHTML=''; addMsg('assistant','Yeni sohbete hazırım. Ne sormak istersin?'); });
  modelSel.addEventListener('change', async ()=>{ const want = modelSel.value; localStorage.setItem('cochi_model', want); engine=null; setProgress(true, 0, 'Model değiştiriliyor…'); try{ await initEngine(); }catch(_){} addMsg('assistant', `Model değişti: ${modelSel.options[modelSel.selectedIndex].text}.`); });

  // Hoş geldin
  const s = support();
  if (!s.ok){ notice.innerHTML = '💡 Çalışması için <b>https veya localhost</b> ve <b>WebGPU destekli tarayıcı</b> gerekir (Chrome/Edge – masaüstü).'; }
  addMsg('assistant', 'Merhaba! Ben Çöçi AI. Tamamen ücretsizim ve tarayıcında çalışıyorum. Bana istediğini sorabilirsin.');
})();
</script>
</body>
</html>
